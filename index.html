<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Human Collaboration Chat</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        .chat-container { width: 80%; max-width: 600px; margin: 0 auto; border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; }
        .input-container { margin-top: 10px; }
        input { width: 70%; padding: 10px; }
        button { padding: 10px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>AI-Human Collaboration Chat</h1>
    <div class="chat-container" id="chat"></div>
    <div class="input-container">
        <input type="text" id="username" placeholder="Enter your name">
        <input type="text" id="userInput" placeholder="Type your message...">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, updateDoc, doc, where } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAC-JFepjFjJA7iRtRsM4EoUiw3Pxfd5Gw",
            authDomain: "ai-human-collaboration-chat.firebaseapp.com",
            projectId: "ai-human-collaboration-chat",
            storageBucket: "ai-human-collaboration-chat.appspot.com",
            messagingSenderId: "212270366875",
            appId: "1:212270366875:web:de5fe602f536f87214c63e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const chatCollection = collection(db, "chat");

        // ✅ Make function globally accessible
        window.sendMessage = async function () {
            const username = document.getElementById("username").value.trim() || "Anonymous";
            const userInput = document.getElementById("userInput").value.trim();
            if (userInput === "") return;

            await addDoc(chatCollection, {
                message: userInput,
                timestamp: new Date().toISOString(),
                user: username,
                type: "question",
                processed: false // ✅ New messages are initially unprocessed
            });

            document.getElementById("userInput").value = "";
        };

        function renderMessage(messageData) {
            const chatBox = document.getElementById("chat");
            const messageElement = document.createElement("div");
            messageElement.textContent = `${messageData.user}: ${messageData.message}`;
            chatBox.appendChild(messageElement);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ✅ Render chat messages in real-time
        onSnapshot(query(chatCollection, orderBy("timestamp")), (snapshot) => {
            document.getElementById("chat").innerHTML = "";
            snapshot.docs.forEach(docSnap => renderMessage(docSnap.data()));
        });

        async function aiRespond(userMessage, docRef) {
            const aiResponse = `Saelan: I see your message, "${userMessage}". Here's my response!`;

            // ✅ Check if AI has already responded to this message
            const aiAlreadyResponded = (await query(chatCollection, where("relatedTo", "==", docRef.id))).size > 0;
            if (aiAlreadyResponded) return; // AI skips if already responded

            // ✅ Store AI's response
            await addDoc(chatCollection, {
                message: aiResponse,
                timestamp: new Date().toISOString(),
                user: "Saelan",
                type: "response",
                relatedTo: docRef.id // ✅ Marks this as a response to prevent duplicates
            });

            // ✅ Mark the original message as processed
            await updateDoc(docRef, { processed: true });
        }

        // ✅ Watch for new questions and respond once
        onSnapshot(query(chatCollection, where("processed", "==", false)), async (snapshot) => {
            snapshot.docs.forEach(async (docSnap) => {
                const data = docSnap.data();
                const docRef = doc(db, "chat", docSnap.id);

                if (data.type === "question" && data.user !== "Saelan") {
                    await aiRespond(data.message, docRef);
                }
            });
        });

    </script>
</body>
</html>
